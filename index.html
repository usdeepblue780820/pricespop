<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>價格牌卡產生器 — 自動換頁 + Excel 匯入 + 重排刪除</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
body { font-family:'Noto Sans TC', sans-serif; margin:0; padding:18px; background:#f3f4f6; }
.controls { max-width:1100px; margin:18px auto; }
.page-wrap { max-width:1100px; margin:18px auto; }

/* A4 頁面（預設畫面預覽用） */
.a4-page { background:white; margin:0 auto 18px; box-shadow:0 3px 8px rgba(0,0,0,0.1); width:210mm; padding:6mm 0; }

/* landscape preview for middle-card mode */
.a4-page.landscape { width:297mm; }

/* 卡片尺寸 */
.card-s { width:85mm; height:55mm; }
.card-m { width:125mm; height:55mm; }
.card-l { width:180mm; height:65mm; }

/* 每頁 Grid */
.grid-s { display:grid; grid-template-columns:85mm 85mm; grid-template-rows:repeat(5,55mm); width:170mm; margin:0 auto; gap:0; }
.grid-m { display:grid; grid-template-columns:125mm 125mm; grid-template-rows:repeat(3,55mm); width:250mm; margin:0 auto; gap:0; }
.grid-l { display:grid; grid-template-columns:180mm; grid-template-rows:repeat(4,65mm); width:180mm; margin:0 auto; gap:0; }

/* 卡片內容 */
.price-card { position:relative; overflow:hidden; box-sizing:border-box; padding:6%; }
.price-card img.bg { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:0; }
.price-card .content { position:relative; z-index:2; font-weight:900; color:#111; }
.title { font-size:11pt; color:#0b0b0b; }
.group { font-size:10pt; color:#0b0b0b; margin-left:6px; font-weight:700; }
.price { font-size:12pt; color:#cc2f00; margin-left:2px; font-weight:800; }
.remark { font-size:8pt; margin-top:5px; font-weight:600; color:#111; }

/* 第一行（品名 + 組數 + 價格）不要換行 */
/* 我們用 .title-group 內部的 .group-price 把組數與價格緊貼在一起 */
.title-group { display:flex; align-items:center; gap:8px; white-space:nowrap; overflow:hidden; justify-content:flex-start; }
.title-group .title { display:inline-block; max-width:60%; text-overflow:ellipsis; overflow:hidden; }
.group-price { display:inline-flex; align-items:center; gap:0; }

/* 刪除按鈕 */
.card-del { position:absolute; top:6px; right:6px; width:26px; height:26px; border-radius:50%; background:#e53e3e; color:#fff; border:none; font-weight:bold; z-index:3; cursor:pointer; box-shadow:0 1px 3px rgba(0,0,0,0.2); }

/* 隱藏列印時的刪除按鈕 */
@media print { .card-del { display:none !important; } }

/* 頁面控制 */
.page-controls { display:flex; gap:8px; align-items:center; }
.page-num { width:72px; padding:6px; border:1px solid #ddd; border-radius:6px; }

/* 列印樣式：列印時改為 A4 landscape（確保中卡列印為橫向） */
@media print {
  body { padding:0; background:white; }
  .no-print { display:none !important; }
  .a4-page { box-shadow:none; margin:0; padding:6mm 0; width:297mm !important; }
  .a4-page.landscape { width:297mm !important; }
  @page { size: A4 landscape; margin: 0; }
}
</style>
</head>
<body>

<!-- 操作區 -->
<div class="controls no-print">
  <!-- 程式名稱與貓腳印 -->
  <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
    <!-- 貓腳印 SVG -->
    <div aria-hidden="true" style="width:44px;height:44px;display:flex;align-items:center;justify-content:center;background:transparent;border-radius:8px;">
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4.5 9a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z" fill="#5EC8F8"/>
        <path d="M9 6.5a1.8 1.8 0 1 1 0-3.6A1.8 1.8 0 0 1 9 6.5z" fill="#5EC8F8"/>
        <path d="M15 6.5a1.8 1.8 0 1 1 0-3.6A1.8 1.8 0 0 1 15 6.5z" fill="#5EC8F8"/>
        <path d="M19.5 9a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z" fill="#5EC8F8"/>
        <path d="M12 19c-4 0-6-3-6-6 0-3 2-5 6-5s6 2 6 5c0 3-2 6-6 6z" fill="#5EC8F8"/>
      </svg>
    </div>
    <div style="font-size:20px;font-weight:800;color:#111;">價格POP輸出程式</div>
  </div>

  <div style="display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap;">
    <select id="mode" class="px-3 py-2 border rounded">
      <option value="s">小卡 85×55 mm（A4 直排 2×5）</option>
      <option value="m">中卡 125×55 mm（A4 橫排 2×3）</option>
      <option value="l">大卡 180×65 mm（A4 直排 1×4）</option>
    </select>
    <button id="add" class="px-4 py-2 bg-blue-600 text-white rounded">產生牌卡</button>
    <button id="copyPrev" class="px-4 py-2 bg-gray-600 text-white rounded">複製上一筆</button>
    <button id="clear" class="px-4 py-2 bg-yellow-500 text-white rounded">全部清除</button>
    <button id="print" class="px-6 py-2 bg-red-600 text-white rounded">列印</button>
  </div>

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;">
    <input id="name" class="flex-1 px-3 py-2 border rounded" placeholder="品名" />
    <input id="group" class="w-28 px-3 py-2 border rounded" placeholder="組數 (例如 12)" />
    <input id="price" class="w-32 px-3 py-2 border rounded" placeholder="價格" />
    <input id="remark" class="w-48 px-3 py-2 border rounded" placeholder="備註" />
  </div>

  <!-- Excel 匯入 & 頁面刪除 -->
  <div style="margin-top:12px;display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
    <input type="file" id="excel" accept=".xlsx,.xls" />
    <button id="import" class="px-4 py-2 bg-purple-600 text-white rounded">匯入 Excel</button>

    <div class="page-controls">
      <input id="deletePageNum" class="page-num" placeholder="頁碼 (1...)" />
      <button id="deletePageBtn" class="px-3 py-2 bg-red-500 text-white rounded">刪除指定頁</button>
    </div>
  </div>
</div>

<!-- 頁面容器 -->
<div id="pages"></div>

<script>
const pages = document.getElementById('pages');
const modeSel = document.getElementById('mode');
const nameI = document.getElementById('name');
const groupI = document.getElementById('group');
const priceI = document.getElementById('price');
const remarkI = document.getElementById('remark');
const excel = document.getElementById('excel');
const deletePageNum = document.getElementById('deletePageNum');
const BG = 'background.jpg';

// 各模式資訊
const SIZE = {
  s:{cls:'card-s', grid:'grid-s', perPage:10},
  m:{cls:'card-m', grid:'grid-m', perPage:6},
  l:{cls:'card-l', grid:'grid-l', perPage:4}
};

// 儲存上一筆（用於複製上一筆）
let lastInput = {name:'', group:'', price:'', remark:''};

// 以模式分別儲存卡片資料（維持順序）
const cardsByMode = { s:[], m:[], l:[] };

function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// 建立卡片 DOM（有刪除按鈕）
// 將 price 放在 title-group（與 name+group 同列），且 group 與 price 緊貼
function buildCardDOM(cardObj, mode, index){
  const card = document.createElement('div'); card.className='price-card '+SIZE[mode].cls;
  card.dataset.index = index;
  const groupText = cardObj.group ? (escapeHtml(cardObj.group) + '入') : '';
  const priceText = cardObj.price ? escapeHtml(cardObj.price) : '';

  // 組成 title 行： title + group-price (group 和 price 緊接)
  card.innerHTML = ''
    + '<button class="card-del" title="刪除此牌卡">×</button>'
    + '<img class="bg" src="' + BG + '" />'
    + '<div class="content">'
    + '  <div class="title-group">'
    + '    <div class="title">' + escapeHtml(cardObj.name) + '</div>'
    + (groupText ? ('<div class="group-price"><div class="group">' + groupText + '</div>' + (priceText?'<div class="price">' + priceText + ' 元</div>':'') + '</div>') : (priceText?'<div class="group-price"><div class="price">' + priceText + ' 元</div></div>':'' ))
    + '  </div>'
    + (cardObj.remark ? '<div class="remark" style="display:block;margin-top:6px;">' + escapeHtml(cardObj.remark) + '</div>' : '')
    + '</div>';
  const delBtn = card.querySelector('.card-del');
  if (delBtn) delBtn.addEventListener('click', ()=>{ deleteCardAt(mode, index); });
  return card;
}

// 重新繪製目前模式的頁面
function renderPagesFor(mode){
  pages.innerHTML = '';
  const arr = cardsByMode[mode];
  const per = SIZE[mode].perPage;
  const pageCount = Math.max(1, Math.ceil(arr.length / per));
  for(let p=0;p<pageCount;p++){
    const page = document.createElement('div'); page.className='a4-page'; page.dataset.mode = mode; page.dataset.pageIndex = p;
    if(mode === 'm') page.classList.add('landscape');

    // 頁首：頁碼
    const header = document.createElement('div');
    header.className = 'page-header';
    header.style.textAlign = 'center';
    header.style.fontSize = '10pt';
    header.style.padding = '4px 0';
    header.style.marginBottom = '4mm';
    header.textContent = '第 ' + (p+1) + ' / ' + pageCount + ' 頁';
    page.appendChild(header);

    const grid = document.createElement('div'); grid.className = SIZE[mode].grid;
    // 填充卡片
    const start = p*per; const end = Math.min(start+per, arr.length);
    for(let i=start;i<end;i++){
      const cardDom = buildCardDOM(arr[i], mode, i);
      grid.appendChild(cardDom);
    }
    page.appendChild(grid);
    pages.appendChild(page);
  }
  if(arr.length===0){
    const page = document.createElement('div'); page.className='a4-page'; page.dataset.mode = mode; page.dataset.pageIndex = 0; if(mode === 'm') page.classList.add('landscape');
    const header = document.createElement('div'); header.className='page-header'; header.style.textAlign='center'; header.style.fontSize='10pt'; header.style.padding='4px 0'; header.style.marginBottom='4mm'; header.textContent = '第 1 / 1 頁';
    const grid = document.createElement('div'); grid.className = SIZE[mode].grid;
    page.appendChild(header); page.appendChild(grid); pages.appendChild(page);
  }
}

// 新增一張卡片（產生牌卡）
function addCard(){
  const m = modeSel.value;
  const name = nameI.value.trim();
  const group = groupI.value.trim();
  const price = priceI.value.trim();
  const remark = remarkI.value.trim();
  if(!name || !price){ alert('請輸入品名與價格'); return; }
  cardsByMode[m].push({name, group, price, remark});
  lastInput = {name, group, price, remark};
  // 清除欄位
  nameI.value=''; groupI.value=''; priceI.value=''; remarkI.value=''; nameI.focus();
  renderPagesFor(m);
}

// 複製上一筆
function copyPrev(){ if(!lastInput.name){ alert('沒有上一筆可複製'); return; } nameI.value = lastInput.name; groupI.value = lastInput.group; priceI.value = lastInput.price; remarkI.value = lastInput.remark; nameI.focus(); }

// 匯入 Excel（將資料追加到目前模式）
function importExcel(){
  const file = excel.files[0]; if(!file){ alert('請選擇 Excel 檔案'); return; }
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const wb = XLSX.read(e.target.result, {type:'binary'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, {header:1});
      const m = modeSel.value;
      // 支援兩種 Excel 排列：
      // 1) [name, price, remark]
      // 2) [name, group, price, remark]
      data.forEach(row=>{ 
        if(!row[0]) return; 
        let obj = {name: String(row[0]), group:'', price:'', remark:''};
        if(row.length>=4){ obj.group = String(row[1]||''); obj.price = String(row[2]||''); obj.remark = String(row[3]||''); }
        else { obj.price = String(row[1]||''); obj.remark = String(row[2]||''); }
        cardsByMode[m].push(obj);
        lastInput = {name: obj.name, group: obj.group, price: obj.price, remark: obj.remark};
      });
      renderPagesFor(m);
    }catch(err){ console.error(err); alert('讀取 Excel 發生錯誤'); }
  };
  reader.readAsBinaryString(file);
}

// 清除所有頁面與資料
function clearAll(){ cardsByMode.s = []; cardsByMode.m = []; cardsByMode.l = []; pages.innerHTML=''; renderPagesFor(modeSel.value); }

// 刪除指定頁面（1-based）並重排後續卡片
function deletePage(){
  const v = parseInt(deletePageNum.value,10);
  if(isNaN(v) || v<1){ alert('請輸入有效頁碼（1 起）'); return; }
  const m = modeSel.value;
  const arr = cardsByMode[m];
  const per = SIZE[m].perPage;
  const idx = v-1;
  const start = idx * per;
  if(start >= arr.length && arr.length>0){ alert('頁碼超出範圍'); return; }
  arr.splice(start, per);
  renderPagesFor(m);
  alert('已刪除第 '+v+' 頁，並已向前重排後續卡片');
}

// 刪除單一牌卡（指定模式與該模式陣列索引）
function deleteCardAt(mode, index){
  const arr = cardsByMode[mode];
  if(index<0 || index>=arr.length) return;
  arr.splice(index,1);
  renderPagesFor(mode);
}

// 列印（使用 template literal 多行提示）
function printAll(){
  alert(`列印前請確認：
1) 紙張 A4
2) 邊距 無 / 最小
3) 開啟背景圖形
4) 縮放 100%`);
  window.print();
}

// 綁定事件
document.getElementById('add').onclick = addCard;
document.getElementById('copyPrev').onclick = copyPrev;
document.getElementById('clear').onclick = clearAll;
document.getElementById('print').onclick = printAll;
document.getElementById('import').onclick = importExcel;
document.getElementById('deletePageBtn').onclick = deletePage;

// Enter 快捷鍵：品名/價格輸入後 Enter -> 產生牌卡
[nameI, groupI, priceI, remarkI].forEach(el=>el.addEventListener('keydown', (e)=>{ if(e.key==='Enter') addCard(); }));

// 切換模式時顯示該模式的頁面
modeSel.addEventListener('change', ()=> renderPagesFor(modeSel.value));

// 初始化：建立第一頁
(function init(){ renderPagesFor(modeSel.value); })();

</script>
</body>
</html>
